# Todo: 天気連携CLI（todo-weather-cli）

## 概要

日本語の対話的CLIで動作するTodoリスト管理アプリの仕様。タスクの登録・一覧・詳細閲覧・更新・削除をサポートし、タスクにはID、タイトル、完了有無、優先度（高/中/低）、場所、期限を持たせる。

場所に基づいて外部天気予報を利用し、期限内で降水確率と気温を考慮して最適な日（候補日）を自動的に提案・登録する。候補日はほかのタスク候補日と重複しないように調整する。期限内で最適な日がない場合は利用可能な空き日を予備日として提示する。タスクが完了状態になったら削除する。

出力は日本語で行い、不正入力時は分かりやすいエラーメッセージを表示する。

## 背景と目的

- 日程調整を天気の観点から支援することで、屋外タスクや天候に左右される予定の失敗を減らす。
- CLIで軽量に使えることを優先し、ローカル環境で簡単に運用できるようにする。

## アクター

- エンドユーザー: コマンドラインからタスクを操作する人。

## 入力・出力（データ）

- タスク: `id`, `title`, `completed` (bool), `priority` (高/中/低), `location` (都市名 と 緯度経度 と タイムゾーン), `due_date` (日時), `candidate_dates` (候補日リスト、各候補に降水確率・予想気温を付与)
- CLIコマンド入力（日本語対応の自然言語日時を含む）
- 日本語の出力（一覧・詳細・エラー・候補日の説明）

## 制約

- 外部の天気データと地名→緯度経度変換は、APIキーが不要なサービスを利用すること（具体的なサービスは実装段階で決定する）。
- 日付・時間は場所のタイムゾーンに基づいて解釈・表示すること。
- 候補日は既存のタスク候補日と被らないこと。

## 永続化と競合ルール（仕様への反映）

- 永続化方法: 単一JSONファイルを採用する（デフォルト）。理由: 実装と移行が簡単で可搬性が高い。ファイルパスはユーザーが設定可能とし、大量データや同時更新が想定される場合はSQLiteなどへの移行を案内する。
- 候補日競合ルール: 先に登録されたタスクを優先する（FIFO）。同一日に複数の候補要求が発生した場合、後から割り当てられたタスクは別の候補日に再選定され、ユーザーに通知される。

## ユーザーシナリオ & テスト

1. タスク登録（自然言語日付）
   - 事例: ユーザーが `追加 タスク: "公園清掃", 期限: 明日, 優先度: 高, 場所: 東京` と入力する。
   - 期待結果: 明日の日時が正しく解釈されタスクが登録される。場所は都市名から緯度経度に変換され、候補日が天気に基づいて提案されタスクに保存される。

2. タスク一覧表示
   - 事例: `一覧` コマンドを実行する。
   - 期待結果: 期限順に整列したタスク一覧を日本語で表示。各タスクに候補日（降水確率・予想気温）を表示する。

3. タスク詳細表示
   - 事例: `詳細 3`（ID指定）
   - 期待結果: タスクの全フィールドを表示。候補日の理由（降水確率が低い等）を説明する。

4. タスク更新（完了）
   - 事例: `更新 3 完了` を実行する。
   - 期待結果: タスクが完了扱いとなり、その後自動的に削除され一覧に現れなくなる。

5. タスク削除
   - 事例: `削除 5` を実行する。
   - 期待結果: 指定IDのタスクが削除される。削除確認のプロンプトを表示する。

6. カレンダービュー
   - 事例: `カレンダー 2026-01` または `カレンダー`（今月）
   - 期待結果: 指定月のカレンダー形式でタスクを日付順に表示。候補日はハイライトされ、気温・降水確率も表示される。

7. 日付パースの多様表現テスト
   - 事例: `明日`, `明後日`, `来週の月曜`, `来月の第2金曜`, `2026/01/05 14:00` などを入力してそれぞれ正しく登録できること。

## 機能要件（試験可能な要件）

1. タスクCRUD
   - 登録: タスクを追加できること（IDは一意）
   - 一覧: 期限順で一覧表示できること
   - 詳細: ID指定で全項目が表示されること
   - 更新: タスクの任意項目を更新できること
   - 削除: タスクを削除できること

2. 日付パース
   - 日本語の自然表現（例: 明日、来週の月曜、来月の第1日曜、等）を解釈して正確な日時に変換できること
   - タイムゾーンは場所のタイムゾーンで解釈されること

3. 地名→座標変換
   - ユーザーが都市名を入力すると、その都市の緯度・経度とタイムゾーンを取得してタスクに保存すること

4. 天気連携と候補日選定
   - 期限内の各日について降水確率と気温を参照し、最も降水確率が低く（必要なら気温閾値も考慮して）候補日を決定すること
   - 選ばれた候補日は既存の候補日と被らないように調整すること
   - 期限内に適切な日がない場合、ユーザーに利用可能な空き日を1〜3件提案すること

5. カレンダー表示
   - 月指定でカレンダー形式にタスクを表示し、候補日・期限・気象情報が確認できること

6. 入力検証とエラー表示
   - 不正な日時、存在しない都市名、範囲外の優先度などの入力はユーザーに理解しやすくエラーを返すこと

7. 完了時の自動削除
   - タスクが完了としてマークされた場合、自動的にストレージから削除され一覧に表示されないこと

## 成功基準（検証可能）

- 主要な日本語日時表現のうち、開発で定義した50件の代表表現に対して95%で正しく日時解釈されること（テストケースで検証）。
- 候補日選定は候補決定要求から10秒以内に完了すること（ローカル環境の標準PCでの目安）。
- 候補日は他のタスク候補日と重複しないこと（重複なしを自動確認できるテストで検証）。
- カレンダービューで月の表示が視認可能であること（主要な月表示テストケースで確認）。

## キーエンティティ

- Task
  - id: 整数
  - title: 文字列
  - completed: 真偽値
  - priority: 列挙（高/中/低）
  - location: { name, latitude, longitude, timezone }
  - due_date: タイムゾーン付き日時
  - candidate_dates: [{ date, precipitation_probability, temperature, reason }]

## 受け入れ基準

- 各機能要件項目に対して受け入れテストを作成し、すべてパスしたら合格とする。
- 2名のユーザーが手動で主要コマンドを試して動作確認を行う。

## 依存関係と前提

- インターネット接続が必要（天気・ジオコーディング取得のため）。
- 外部の天気/ジオコーディングサービスはAPIキー不要のものを利用することを前提とする（具体的なサービスは実装段階で決定する）。

## 想定する実装上の仮定

- 永続化方法はデフォルトで単一JSONファイルを利用する想定とする。必要に応じてSQLiteなどへの移行を検討する。
- 候補日の競合は先に登録されたタスクを優先（FIFO）とする。
- タイムゾーンは地理座標から決定する。

## 除外事項

- 他ユーザーとの共有カレンダー同期や、外部カレンダー（Google Calendar等）との統合は対象外。
- ユーザー認証や複数ユーザー管理は対象外。

## 次のステップ

1. 仕様の反映（完了済み）: 永続化をJSON、競合ルールをFIFOで反映しました。
2. 実装プラン(`/speckit.plan`)を作成して実装フェーズへ進む。

---

## エッジケース

- 都市名が曖昧で複数候補が返る場合: ユーザーに候補リストを提示して選択させる。
- ジオコーディングや天気APIが一時的に利用不可の場合: ユーザーにエラーメッセージを表示し、ローカルにキャッシュされている最終結果が利用可能ならそれを提案する。
- 期限が当日で天気的に適切な日がない場合: 利用可能な空き日（期限後含むオプションは明示的に許可がある場合のみ）を提案する。
- タイムゾーンの境界（夏時間/冬時間）による曖昧さ: 地点のタイムゾーン情報を用いて正しく解釈し、ユーザーに明示的な表示を行う。
- 候補日が複数タスクと競合し、再選定ができない場合: ユーザーに手動調整を促す通知を表示する。

---

（この仕様は日本語で書かれており、ビジネス側の要件・検証基準に焦点を当てています。実装の詳細（言語・ライブラリ等）は含めていません。）
