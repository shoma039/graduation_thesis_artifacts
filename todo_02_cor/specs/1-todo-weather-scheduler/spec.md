# Todo CLI: 対話的Todoリストアプリ（天気ベースの候補日選定）

**短い説明**
- Python製のCLIで対話的に使えるTodoリストアプリ。登録・一覧・詳細表示・更新・削除をサポートし、場所の天気予報を使って期限内の最適な候補日を自動で選定・提案する。

**目的 (Why)**
- ユーザーが期限内に天候の良い日を自動で提案され、予定の調整を容易にすることでタスク完了率と計画の実行性を向上する。

**スコープ（何を含むか）**
- 含む: タスクの登録/一覧/詳細/更新/削除、日付の自然言語入力（例: 明日、来週の月曜）、都市名→緯度経度変換（APIキー不要）、天気予報取得（APIキー不要）、期限内の最適日選定、候補日の重複回避、候補日の代替提案、月表示のカレンダー機能、タイムゾーンを考慮した日時処理、完了タスクは削除する自動処理、不正入力時のエラー表示、日本語出力。
- 含まない: GUI、外部サービスへの書き込み、ユーザー認証、サードパーティの有料API（APIキー不要の公開APIのみ使用）

**アクター**
- エンドユーザー（CLIで操作する一般ユーザー）
- システム（自動で天気を取得して候補日を決定する部分）

**主要データ要素**
- Task: ID (整数), Title (文字列), Completed (真偽), Priority (低/中/高), Location (都市名 + 緯度経度), DueDate (期限), CandidateDate(s) (候補日), CreatedAt, UpdatedAt
- Location: name, latitude, longitude, timezone
- WeatherForecast: date, precipitation_probability (%), temperature_min/temperature_max (℃)

**ユーザーシナリオ & テスト**
- シナリオ 1: タスク登録（自然言語で期限指定）
  - 操作: ユーザーが `add` コマンドでタイトル、場所、期限に "明日" を入力する。
  - 期待: 自然言語を解釈して期限日時を登録し、場所をジオコーディングして緯度経度とタイムゾーンを保存。天気予報を取得して、期限内の最適な候補日を1つ候補日に登録する。CLIは結果を日本語で表示。
  - テスト: `add` 後に `show <id>` で CandidateDate が存在し、期限内かつ降水確率が低い日が選ばれていること。

- シナリオ 2: 候補日競合回避
  - 操作: 既存タスクと新規タスクの候補日が同日になり得る場合に新規タスクは別日に割り当てられる。
  - 期待: 候補日は他タスクと被らない。競合が発生した場合は「先着順（作成日時が早いものを優先）」で自動的に割り当てられる。
  - テスト: 同じ最適日が算出される条件で2つのタスクを作成し、最終的に候補日が重複しないことを確認する。

- シナリオ 3: 最適日が期限内にない場合
  - 操作: 期限内に降水確率が低い日が無いケース。
  - 期待: 空いている近い日を予備日として提案し、気温も併せて表示する。
  - テスト: 期限内に該当候補日が無い一連の条件を用意し、提案が表示されることを確認する。

- シナリオ 4: 更新と完了
  - 操作: `update <id> --complete true` を実行
  - 期待: タスクが完了と見なされ、データストアから削除される。
  - テスト: 完了更新後に `show <id>` がエラーになる（存在しない）こと。

- シナリオ 5: カレンダー表示
  - 操作: `calendar --month 2025-12` のように指定
  - 期待: 指定月のタスク候補日/期限日を日付順に見やすく表示できる。
  - テスト: 複数タスクを作成して月表示で順序が正しいことを確認する。

**機能要件（テスト可能）**
1. タスク作成: CLIコマンドでタイトル・場所・期限を入力すると新規タスクが作成される。作成時にIDを返す。
2. 日付パース: 自然言語（日: "明日", "来週の月曜" 等）を正しく具体日時に変換し、ユーザーに確認を求められる（または自動確定）。
3. ジオコーディング: 都市名から緯度/経度/タイムゾーンを取得して保存する（APIキー不要のジオコーディングを使う）。
4. 天気取得: 登録した場所の天気予報（少なくとも降水確率と気温）を取得できる（APIキー不要の天気APIを使用）。
5. 候補日算出: 期限内の日について降水確率が最も低い日を優先して1つ候補日として選定する。候補日は他タスクと被らないこと。
6. 候補日競合回避: 候補日が他タスクと被る場合、回避ロジックを適用して別日を割り当てる（詳細は要確認）。
7. 代替日提案: 期限内に適切な候補日が無い場合、空き日を提案する（提案日と気温を表示）。
8. 完了処理: タスクを完了に更新したらデータストアから削除される。
9. 一覧/詳細/更新/削除: CLIで一覧、詳細表示、フィールド更新、削除が可能である。
10. カレンダー表示: 月を指定して日付順で見やすく表示する。
11. タイムゾーン: 期限や天気APIの日時は場所のタイムゾーンで正しく扱う。
12. エラーハンドリング: 不正入力時は日本語で分かりやすいエラーメッセージを出す。

**成功基準（測定可能・技術非依存）**
- ユーザーはタスク登録から候補日提案までを 1 分以内に完了できること（主観評価とタイムドテスト）。
- 既存ユーザーのタスク候補日の重複率が 0%（自動割り当て後の検証）。
- 期限内に天候基準で候補日を選べなかったタスクのうち、代替提案が提示される割合が 100%。
- タスク完了更新後に該当タスクがストレージ上から削除され、`show <id>` が失敗すること。

**主要エンティティ**
- Task { id: int, title: str, completed: bool, priority: enum(low,medium,high), location_id, due_date (datetime with tz), candidate_date (datetime with tz), created_at, updated_at }
- Location { id, name, latitude, longitude, timezone }
- Forecast { location_id, date (with tz), precipitation_prob, temp_min, temp_max }

**前提・仮定**
- ジオコーディングと天気APIはAPIキー不要の公開APIを使用する。これにより追加のAPIキー登録は不要とする。
- 自然言語の日時パースは日本語入力を想定し、適切なライブラリで処理する。
- タスクの優先度は "高/中/低" の3段階とする。
- 候補日は1つだけ自動割当てとする（将来的に複数候補の拡張は可能）。
- 候補日競合解決ポリシーは "先着順（作成日時が早いもの優先）" とする。

**セキュリティ・プライバシー**
- ローカルでのストレージを想定（ファイルまたは軽量なローカルDB）。外部へユーザーデータを送信しないことを推奨。

**実装に影響する不明点（要確認: 最大3件まで）**
- なし（候補日競合は「先着順（作成日時が早いもの優先）」で解決する方針に決定）

**次のステップ**
- 上記の未確定点（候補日競合解決）について方針を決める。
- スペックを確定後、実装のタスク分割と見積もりを行う。

---

*作成日: 2025-12-10*
