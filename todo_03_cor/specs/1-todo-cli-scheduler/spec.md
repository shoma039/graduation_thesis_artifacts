# Feature Specification: Todo CLI Scheduler

**Feature Branch**: `1-todo-cli-scheduler`  
**Created**: 2025-12-10  
**Status**: Draft  
**Input**: User description: "Pythonで、CLI上で対話的に実行できるTodoリストアプリを作成したい。基本的な機能として登録・一覧・詳細・更新・削除の設定を入れる。タスクにはIDとタイトルと完了の有無、優先度（三段階）、場所、期限の情報を持たせる。日付入力時、『明日』『来週の月曜』といった言葉でも正確に登録できるようにする。外部の天気予報を使用し、登録した場所の降水確率によって、期限内で最適な日を天気で選択する。選択した日はタスクに候補日として登録する。候補日はほかのタスク候補日と被らないようにする。期限内で最適な日がない場合、空いている日に予備の日程を提案するまた気温も表示する。タスクを更新して完了となったらそのタスクは削除すること。カレンダー機能を追加して、登録したものを日付順で見やすくして月も選べるようにする。期限の扱い、天気APIの日時の処理などは、場所のタイムゾーンを用いて正しく変換すること。天気予報を正確に取得するために都市名を入力したら自動でGPS（緯度・経度）に変換して保存すること。外部APIには、APIキー登録不要なものを使用する。不正入力時はエラー表示する。出力は日本語で分かりやすいようにする。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - タスクの登録と自然言語日付入力 (Priority: P1)

ユーザーはCLIで対話的に新しいタスクを登録できる。日付は「明日」「来週の月曜」などの自然言語で入力でき、システムは正しい日付に変換して保存する。

**Why this priority**: 基本的なタスク登録ができなければ以降のスケジューリングや表示機能が使えないため。

**Independent Test**: CLIでタスク登録コマンドを実行し、自然言語の期限を入力してタスクが正しい日付で保存されることを確認する。

**Acceptance Scenarios**:

1. **Given** 新規タスク登録画面、 **When** 期限に「明日」と入力、 **Then** タスクに正しい翌日の日付が保存される。
2. **Given** 期限に「来週の月曜」と入力（現在のタイムゾーンを考慮）、 **When** 登録完了、 **Then** その週の月曜の日付が保存される。

---

### User Story 2 - 天気に基づく候補日の自動選定 (Priority: P1)

ユーザーがタスクを登録すると、システムは登録された場所の天気予報を取得し、期限内で降水確率が最も低い日を候補日として提案する。候補日は既存の他タスクの候補日と重複しないよう選定する。

**Why this priority**: 本機能はこのプロダクトの差別化要素であり、ユーザーが実際にタスク実行日を決める助けとなるため。

**Independent Test**: 既存タスクと重なる候補日がない状態で新タスクを登録し、候補日が期限内かつ降水確率が最小であり、他タスクと重複していないことを確認する。

**Acceptance Scenarios**:

1. **Given** 期限が5日後、 **When** タスク登録時に天気データを取得、 **Then** 期限内の降水確率最小日が候補日として保存される。
2. **Given** 候補日が他タスクと重複する場合、 **When** 自動選定を行う、 **Then** 次の最適（降水確率が低い）かつ空いている日が選ばれる。
3. **Given** 期限内に最適日が存在しない場合、 **When** 候補日を決められない、 **Then** ユーザーに空き日（期限外含む予備日）を1件以上提示する。

---

### User Story 3 - タスク一覧・詳細・更新・削除（完了時自動削除） (Priority: P2)

ユーザーは登録済みタスクを一覧で確認し、個別の詳細を見て更新や削除ができる。タスクを「完了」に更新した際は自動的に記録から削除される（下のAssumptionsで選択肢を提示）。

**Why this priority**: CRUD 操作は基本機能として必須である。

**Independent Test**: タスクを完了に更新した際、一覧から消えることを確認する。

**Acceptance Scenarios**:

1. **Given** タスク一覧表示、 **When** タスクIDを指定して詳細表示、 **Then** ID・タイトル・優先度・場所・期限・候補日が表示される。
2. **Given** タスクを完了に更新、 **When** 更新処理完了、 **Then** タスクは一覧から削除される（アーカイブの有無は要確認）。

---

### User Story 4 - カレンダー表示 (Priority: P2)

ユーザーは月単位でカレンダーを選択し、日付順でタスク（候補日含む）を確認できる。月を切り替えて別月の予定を表示できる。

**Why this priority**: 視認性が高く、スケジュール確認が容易になるため。

**Independent Test**: 指定した月を表示し、その月に該当する候補日・期限が日付順で並ぶことを確認する。

**Acceptance Scenarios**:

1. **Given** カレンダービューで2025年12月を指定、 **When** 表示、 **Then** その月のタスク候補日と期限が日付順で表示される。

---

### Edge Cases

- 存在しない都市名を入力した場合、ユーザーに明確なエラーメッセージを表示し再入力を促す。
- 期限が過去日に設定された場合、登録を拒否してエラーを表示する。
- 複数タスクが同一優先度かつ候補日が同じ場合の衝突は「先に登録されたタスクを優先」して次善の日を選ぶ。
- タイムゾーンが異なる場所で期限が日付境界をまたぐ場合、場所のタイムゾーンで正しく解釈・表示する。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: CLI 上でタスクの登録・一覧・詳細表示・更新・削除（完了時の削除を含む）を行えること。
- **FR-002**: タスクは少なくとも次の属性を持つこと: ID, タイトル, 完了フラグ, 優先度（高/中/低の3段階）, 場所（入力された都市名と保存用の緯度/経度）, 期限日。
- **FR-003**: 日付入力は自然言語（例: 「明日」「来週の月曜」）を受け付け、ユーザーの想定する日付に解釈して保存すること。タイムゾーンは場所に紐づけて変換する。
- **FR-004**: 都市名から緯度・経度を自動取得して保存すること（ユーザーに緯度/経度を明示的に編集するオプションを提供してもよい）。
- **FR-005**: 外部天気予報を取得して、期限内で最適（降水確率が最小）な候補日を選定し、タスクへ候補日として登録すること。
- **FR-006**: 候補日は既存の他タスクの候補日と重複しないように選定すること。重複がある場合は次点の候補日を選ぶ。
- **FR-007**: 期限内で最適日がない場合、期限外の「空き日」候補を1件以上提示すること。提示にはその日の降水確率と予想気温を表示する。
- **FR-008**: タスクを「完了」に更新した場合、対象タスクを削除する（アーカイブの可否は下のAssumptionsで扱う）。
- **FR-009**: カレンダービューで月を選択し、当月のタスク（期限・候補日）を日付順で一覧表示できること。
- **FR-010**: 不正入力（無効な日付形式、存在しない都市名、必須項目の欠落など）は明確な日本語のエラーメッセージを返すこと。

### Key Entities

- **Task**: ID, タイトル, 完了フラグ, 優先度, 場所参照, 期限日, 候補日（0..n）
- **Location**: 入力名（都市名など）, 緯度, 経度, タイムゾーン
- **CandidateDate**: 日付（ローカル日付として保存）, 関連タスクID, 降水確率, 予想気温, 選定理由（例: "降水確率最小"）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: P1レベルの主要フロー（タスク登録→候補日自動選定→一覧表示）が手順通りに実行可能で、手動テストで再現可能であること。
- **SC-002**: 自然言語入力した日付のうち95%以上がユーザー期待日と一致する（テストケース集で検証）。
- **SC-003**: 候補日選定時、選ばれた候補日は他タスクの候補日と重複しない（自動テストで検証可能、重複は0件）。
- **SC-004**: 期限内に適切な候補日がない場合、システムは最低1件の代替日を提示し、その日の降水確率と予想気温を表示すること。
- **SC-005**: カレンダービューで月を切り替えたとき、該当月の項目が正しく日付順で表示される（手順化された受け入れテストで確認）。

## Assumptions

- 天気とジオコーディングには「APIキー不要」の公開サービス（例: ジオコーディングや天気予報の公開エンドポイント）を使うことを想定する。ただし実際の利用可否は利用条件に依存するため実装前に最終確認を行う。
- タスクの永続化方法はローカル単一ファイル（JSON）とする。簡易で移行が容易なため初期実装に適している。将来的に検索性能や同期が必要な場合はSQLiteやクラウド同期を検討する。
- 完了タスクの自動削除については要確認。即時永久削除を行うと誤操作で履歴を失う可能性があるため、アーカイブ保存を希望する場合は仕様を変更する必要がある（最大3つの選択肢を提示予定）。
- 日付解釈はユーザーのロケーション（場所に紐づくタイムゾーン）で行う。

## Notes

- 本仕様はユーザーが要求した日本語出力と自然言語日付解釈、APIキー不要の外部サービス利用要件を優先して作成した。実装にあたっては外部サービスの利用規約と利用可能なエンドポイントを確認すること。

## Files to be created

- `specs/1-todo-cli-scheduler/spec.md` (このファイル)
- `specs/1-todo-cli-scheduler/checklists/requirements.md`
